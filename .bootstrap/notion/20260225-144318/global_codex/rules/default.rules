# ~/.codex/rules/default.rules
# Codex가 '샌드박스 밖'에서 실행하려는 커맨드에 대한 실행 정책입니다.

# -------------------------
# 1) 파일/폴더 삭제: 금지
# -------------------------
prefix_rule(
    pattern = [["rm", "del", "rmdir"]],
    decision = "forbidden",
    justification = "파일/폴더 삭제 금지. 필요하면 old/로 보관하거나 .bak 백업을 사용하세요.",
    match = ["rm -rf node_modules", "del /f /q something.txt", "rmdir /s /q build"],
)

prefix_rule(
    pattern = ["git", "rm"],
    decision = "forbidden",
    justification = "git rm은 파일 삭제/인덱스 제거를 유발합니다. 삭제는 금지입니다.",
    match = ["git rm -r src/old"],
)

# PowerShell 계열(완전 커버는 어렵지만 최소 차단)
prefix_rule(
    pattern = ["Remove-Item"],
    decision = "prompt",
    justification = "Remove-Item은 삭제/파괴 가능성이 큼. 승인 전 명령을 다시 확인하세요.",
    match = ["Remove-Item -Recurse -Force node_modules"],
)

# -------------------------
# 2) 이동/리네임: 항상 승인(prompt)
# -------------------------
prefix_rule(
    pattern = [["mv", "move", "ren"]],
    decision = "prompt",
    justification = "파일/폴더 이동/리네임은 사전 합의가 필요합니다. 영향 범위와 롤백 방법을 먼저 확인하세요.",
    match = ["mv src/a.ts src/b.ts", "move a b", "ren a.txt b.txt"],
)

prefix_rule(
    pattern = ["git", "mv"],
    decision = "prompt",
    justification = "git mv는 경로 변경을 유발합니다. 사전 합의 후 진행하세요.",
    match = ["git mv src/a.ts src/b.ts"],
)

# -------------------------
# 3) 패키지 매니저: 프로젝트 정책 확인(prompt)
# -------------------------
prefix_rule(
    pattern = [["yarn", "pnpm", "bun"]],
    decision = "prompt",
    justification = "패키지 매니저는 프로젝트 정책(Project_Context.md)을 따릅니다. 승인 전 확인하세요.",
    match = ["yarn install", "pnpm i", "bun install"],
)

# -------------------------
# 4) Git 위험 커맨드: 최소한 prompt/forbidden
# -------------------------
prefix_rule(
    pattern = ["git", "push"],
    decision = "prompt",
    justification = "git push는 원격에 영향을 줍니다. 승인 전 브랜치/리모트/옵션을 확인하세요.",
    match = ["git push origin main"],
)

prefix_rule(
    pattern = ["git", "push", ["--force", "--force-with-lease"]],
    decision = "forbidden",
    justification = "강제 푸시(--force/--force-with-lease) 금지. 필요 시 사용자와 합의 후 안전한 대안을 선택하세요.",
    match = ["git push --force origin main"],
)

prefix_rule(
    pattern = ["git", "reset", "--hard"],
    decision = "prompt",
    justification = "git reset --hard는 로컬 변경을 소실시킬 수 있습니다. 승인 전 대상 커밋/브랜치를 확인하세요.",
    match = ["git reset --hard HEAD~1"],
)

prefix_rule(
    pattern = ["git", "clean"],
    decision = "prompt",
    justification = "git clean은 추적되지 않은 파일을 삭제할 수 있습니다. 승인 전 옵션(-fdx 등)을 확인하세요.",
    match = ["git clean -fd"],
)
prefix_rule(pattern=["C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "-Command", "Get-ChildItem -Recurse -Force .agent | Select-Object FullName,Name,Length,LastWriteTime"], decision="allow")
prefix_rule(pattern=["C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "-Command", "Get-ChildItem -Force docs/Progress | Select-Object Name,Length,LastWriteTime"], decision="allow")
prefix_rule(pattern=["C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "-Command", "$files = Get-ChildItem -Recurse -Filter SKILL.md C:/Users/DJ/.codex/skills | Sort-Object FullName; foreach ($f in $files) { Write-Output ('### ' + $f.FullName); Get-Content -Encoding UTF8 $f.FullName -TotalCount 18; Write-Output '' }"], decision="allow")

prefix_rule(pattern=["rm"], decision="forbidden", justification="삭제 금지 정책")
prefix_rule(pattern=["rmdir"], decision="forbidden", justification="삭제 금지 정책")
prefix_rule(pattern=["git","rm"], decision="forbidden", justification="삭제 금지 정책")
prefix_rule(pattern=["mv"], decision="prompt", justification="이동/리네임은 사전 승인 필요")
prefix_rule(pattern=["git","mv"], decision="prompt", justification="이동/리네임은 사전 승인 필요")
prefix_rule(pattern=["docker","ps"], decision="allow")
prefix_rule(pattern=["docker","compose"], decision="allow")
prefix_rule(pattern=["supabase","start"], decision="allow")
prefix_rule(pattern=["supabase","status"], decision="allow")
prefix_rule(pattern=["supabase","db","reset"], decision="prompt", justification="DB reset은 파괴적")
